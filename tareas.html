<!DOCTYPE html>
<html class="has-background-dark">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Mis tareas</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.2/css/bulma.min.css">
    </head>

    <body>
        <section class="section">
            <div class="mt-5 container is-fullhd">
                <div class="tabs is-toggle is-toggle-rounded is-fullwidth is-medium">
                <ul>
                    <li class="is-active">
                        <a href="inicio.html">
                            <span class="icon is-small"><i class="fas fa-house"></i></span>
                            <span>Inicio</span>
                        </a>
                    </li>
                    <li>
                        <a class="has-background-link-85 has-text-link-85-invert" href="usuarios.html">
                            <span class="icon is-small"><i class="fas fa-user"></i></span>
                            <span>Usuarios</span>
                        </a>
                    </li>
                    <li>
                        <a class="has-background-link-85 has-text-link-85-invert" href="grupos.html">
                            <span class="icon is-small"><i class="fas fa-user-group"></i></span>
                            <span>Grupos</span>
                        </a>
                    </li>
                </ul>
                </div>
            </div>
        </section>

        <section class="section">
            <div class="columns is-mobile is-multiline is-centered">
                <div class="column is-narrow">
                    <h1 class="title is-1 has-text-light">Mis tareas</h1>
                </div>
            </div>
        </section>

        <section class="section">
            <div id="tareas"></div>
            <div class="field is-grouped is-grouped-centered pt-4">
                <a class="button is-primary is-rounded" href="agregar_tarea.html">
                    Agregar tarea
                </a>
            </div>
        </section>
        <script src="https://kit.fontawesome.com/2c37e7fca6.js" crossorigin="anonymous"></script>
        <script>
            window.onload = function() {
                mostrarTareas()
            }

            mostrarTareas = function() {
                fetch('http://127.0.0.1:3000/api/v1/tareas')
                .then(response => response.json())
                .then(tareas => {
                    let card_tareas = document.getElementById('tareas')
                    tareas.forEach(tarea => {
                        card_tareas.innerHTML += `
                        <div id="tarea-${tarea.id}" class="card column is-three-fifths is-offset-one-fifth has-background-primary-light">
                            <header class="card-header has-background-primary">
                                <p class="card-header-title">${tarea.id}: ${tarea.nombre}</p>
                            </header>
                            <div class="card-content">
                                <div class="content">${tarea.descripcion}.</div>
                                <div class="content">Fecha de inicio: ${tarea.inicio_tarea}</div>
                                <div class="content">Fecha de finalizacion: ${tarea.fin_tarea}</div>
                                <div class="content">Estado: pendiente</div>
                            </div>
                            <footer class="card-footer has-background-primary">
                                <button class="card-footer-item has-text-link" onclick="eliminarTarea(${tarea.id})">Eliminar</button>
                                <a class="card-footer-item" href="editar_tarea.html?id=${tarea.id}">Editar</a>
                                <button class="card-footer-item has-text-link" onclick="tareaCompletada(${tarea})">Completada</button>
                            </footer>
                        </div>`
                    });
                })
            }
            
            tareaCompletada = function(tarea_finalizada) {
                let eliminar = eliminarTarea(tarea_finalizada.id)
                if (!eliminar) {
                    return
                }
                let table = document.getElementById('tareas_completadas')
                let tr = document.createElement('tr')
                tr.id = 'tarea-' + tarea_finalizada.id
                let id = document.createElement('th')
                id.textContent = tarea_finalizada.id
                let nombre = document.createElement('td')
                nombre.textContent = tarea_finalizada.nombre
                let descripcion = document.createElement('td')
                descripcion.textContent = tarea_finalizada.descripcion
                let fecha_inicio = document.createElement('td')
                fecha_inicio.textContent = tarea_finalizada.inicio
                let fecha_fin = document.createElement('td')
                fecha_fin.textContent = tarea_finalizada.fin

                let objetivo = document.createElement('td')
                let ref_objetivo = document.createElement('a')
                ref_objetivo.textContent = '1'
                ref_objetivo.className = 'is-link'
                ref_objetivo.href = "objetivos.html"
                objetivo.appendChild(ref_objetivo)
                let progreso = document.createElement('td')
                progreso.textContent = 'Finalizada'

                tr.appendChild(id)
                tr.appendChild(nombre)
                tr.appendChild(descripcion)
                tr.appendChild(fecha_inicio)
                tr.appendChild(fecha_fin)
                tr.appendChild(objetivo)
                tr.appendChild(progreso)
                table.appendChild(tr)
                
            }

            eliminarTarea = function(id) {
                if (!confirm('Se eliminarÃ¡ la tarea ' + id + ' de tareas pendientes')) {
                    return false
                }
                fetch('http://127.0.0.1:3000/api/v1/tareas/' + id, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(response => {
                    let card = document.getElementById('tarea-' + response.id)
                    card.remove()
                })
                return true
            }
        </script>
    </body>
</html>