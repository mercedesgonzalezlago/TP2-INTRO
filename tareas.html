<!DOCTYPE html>
<html class="has-background-dark">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Mis tareas</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.2/css/bulma.min.css">
    </head>

    <body>
        <section class="section">
            <div class="mt-5 container is-fullhd">
                <div class="tabs is-toggle is-toggle-rounded is-fullwidth is-medium">
                <ul>
                    <li class="is-active">
                        <a href="inicio.html">
                            <span class="icon is-small"><i class="fas fa-house"></i></span>
                            <span>Inicio</span>
                        </a>
                    </li>
                    <li>
                        <a class="has-background-link-85 has-text-link-85-invert" href="usuarios.html">
                            <span class="icon is-small"><i class="fas fa-user"></i></span>
                            <span>Usuarios</span>
                        </a>
                    </li>
                    <li>
                        <a class="has-background-link-85 has-text-link-85-invert" href="grupos.html">
                            <span class="icon is-small"><i class="fas fa-user-group"></i></span>
                            <span>Grupos</span>
                        </a>
                    </li>
                </ul>
                </div>
            </div>
        </section>

        <section class="section">
            <div class="columns is-mobile is-multiline is-centered">
                <div class="column is-narrow">
                    <h1 class="title is-1 has-text-light">Mis tareas</h1>
                </div>
            </div>
        </section>

        <section class="section" id="tareas_pendientes">
            <div class="column is-narrow">
                <h1 class="mb-2 title is-2 has-text-danger">Pendientes:</h1>
            </div>
            <table class="table is-bordered is-hoverable">
                <thead>
                    <tr class="has-background-success-light">
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Descripción</th>
                        <th>Fecha de inicio</th>
                        <th>Fecha de finalización</th>
                        <th>ID objetivo</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody id="info_tareas">
                </tbody>
            </table>
            <div class="field is-grouped pt-4">
                <a class="button is-primary is-rounded" href="agregar_tarea.html">
                    Agregar tarea
                </a>
            </div>
        </section>
        <script src="https://kit.fontawesome.com/2c37e7fca6.js" crossorigin="anonymous"></script>
        <script>
            window.onload = function() {
                mostrarTareas()
            }

            mostrarTareas = function() {
                fetch('http://127.0.0.1:3000/api/v1/tareas')
                .then(response => response.json())
                .then(tarea => {
                    let table = document.getElementById('info_tareas')
                    table.innerHTML = ''
                    tarea.forEach(element => {
                        let tr = document.createElement('tr')
                        tr.id = 'tarea-' + element.id
                        let id = document.createElement('th')
                        id.textContent = element.id
                        let nombre = document.createElement('td')
                        nombre.textContent = element.nombre
                        let descripcion = document.createElement('td')
                        descripcion.textContent = element.descripcion
                        let fecha_inicio = document.createElement('td')
                        fecha_inicio.textContent = element.inicio_tarea
                        let fecha_fin = document.createElement('td')
                        fecha_fin.textContent = element.fin_tarea
                        let objetivo = document.createElement('td')
                        let ref_objetivo = document.createElement('a')
                        ref_objetivo.textContent = '1'
                        ref_objetivo.className = 'is-link'
                        ref_objetivo.href = 'objetivos.html'
                        objetivo.appendChild(ref_objetivo)
                        let borrar = document.createElement('td')
                        let button = document.createElement('button')
                        button.textContent = 'Eliminar'
                        button.className = 'button is-danger is-small'
                        button.onclick = function() { eliminarTarea(element.id) }
                        borrar.appendChild(button)

                        let editar = document.createElement('td')
                        let edit_button = document.createElement('a')
                        edit_button.textContent = 'Editar'
                        edit_button.className = 'button is-warning is-small'
                        edit_button.href = `editar_tarea.html?id=${element.id}`
                        editar.appendChild(edit_button)

                        let completada = {
                            id: element.id,
                            nombre: element.nombre,
                            descripcion: element.descripcion,
                            inicio: element.inicio_tarea,
                            fin: element.fin_tarea
                        }
                        let tarea_completada = document.createElement('td')
                        let complete = document.createElement('button')
                        complete.textContent = 'Completada'
                        complete.className = 'button is-primary is-small'
                        complete.onclick = function() { tareaCompletada(completada) }
                        tarea_completada.appendChild(complete)

                        let progreso = document.createElement('td')
                        progreso.textContent = 'En proceso'

                        tr.appendChild(id)
                        tr.appendChild(nombre)
                        tr.appendChild(descripcion)
                        tr.appendChild(fecha_inicio)
                        tr.appendChild(fecha_fin)
                        tr.appendChild(objetivo)
                        tr.appendChild(progreso)
                        tr.appendChild(borrar)
                        tr.appendChild(editar)
                        tr.appendChild(tarea_completada)
                        table.appendChild(tr)
                    });
                })
            }
            
            tareaCompletada = function(tarea_finalizada) {
                let eliminar = eliminarTarea(tarea_finalizada.id)
                if (!eliminar) {
                    return
                }
                let table = document.getElementById('tareas_completadas')
                let tr = document.createElement('tr')
                tr.id = 'tarea-' + tarea_finalizada.id
                let id = document.createElement('th')
                id.textContent = tarea_finalizada.id
                let nombre = document.createElement('td')
                nombre.textContent = tarea_finalizada.nombre
                let descripcion = document.createElement('td')
                descripcion.textContent = tarea_finalizada.descripcion
                let fecha_inicio = document.createElement('td')
                fecha_inicio.textContent = tarea_finalizada.inicio
                let fecha_fin = document.createElement('td')
                fecha_fin.textContent = tarea_finalizada.fin

                let objetivo = document.createElement('td')
                let ref_objetivo = document.createElement('a')
                ref_objetivo.textContent = '1'
                ref_objetivo.className = 'is-link'
                ref_objetivo.href = "objetivos.html"
                objetivo.appendChild(ref_objetivo)
                let progreso = document.createElement('td')
                progreso.textContent = 'Finalizada'

                tr.appendChild(id)
                tr.appendChild(nombre)
                tr.appendChild(descripcion)
                tr.appendChild(fecha_inicio)
                tr.appendChild(fecha_fin)
                tr.appendChild(objetivo)
                tr.appendChild(progreso)
                table.appendChild(tr)
                
            }

            eliminarTarea = function(id) {
                if (!confirm('Se eliminará la tarea ' + id + ' de tareas pendientes')) {
                    return false
                }
                fetch('http://127.0.0.1:3000/api/v1/tareas/' + id, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(response => {
                    let tr = document.getElementById('tarea-' + response.id)
                    tr.remove()
                })
                return true
            }
        </script>

        <section class="section">
            <div class="column is-narrow">
                <h1 class="mb-2 title is-2 has-text-warning">Completadas:</h1>
            </div>
            <table class="table is-bordered is-hoverable">
                <thead>
                    <tr class="has-background-success-light">
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Descripción</th>
                        <th>Fecha de inicio</th>
                        <th>Fecha de finalización</th>
                        <th>ID objetivo</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody id="tareas_completadas">
                </tbody>
            </table>
        </section>

    </body>
</html>